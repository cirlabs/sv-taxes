<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="css/colorbrewer.css">
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
        <style type="text/css">
            .charts{
                width: 100%;
                height: 500px;
                font-size: .8em;
            }
            .y-axis path,
            .y-axis line {
              fill: none;
              stroke: #000;
              shape-rendering: crispEdges;
            }
            .control {
                -moz-box-shadow:inset 0px 1px 0px 0px #ffffff;
                -webkit-box-shadow:inset 0px 1px 0px 0px #ffffff;
                box-shadow:inset 0px 1px 0px 0px #ffffff;
                background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #ededed), color-stop(1, #dfdfdf) );
                background:-moz-linear-gradient( center top, #ededed 5%, #dfdfdf 100% );
                filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ededed', endColorstr='#dfdfdf');
                background-color:#ededed;
                -moz-border-radius:6px;
                -webkit-border-radius:6px;
                border-radius:6px;
                border:1px solid #dcdcdc;
                display:inline-block;
                color:#777777;
                font-family:arial;
                font-size:10px;
                font-weight:bold;
                padding:6px 17px;
                text-decoration:none;
                text-shadow:1px 1px 0px #ffffff;
            }.control:hover {
                background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #dfdfdf), color-stop(1, #ededed) );
                background:-moz-linear-gradient( center top, #dfdfdf 5%, #ededed 100% );
                filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#dfdfdf', endColorstr='#ededed');
                background-color:#dfdfdf;
            }.control:active {
                position:relative;
                top:1px;
            }
            body{
                font-family: Georgia,Cambria,"Times New Roman",Times,serif;
                margin: 0;
            }
            #info-window{
                width: 22%;
                position: absolute;
                right: 10px;
                z-index: 10;
                padding: 10px;
                border: solid 1px #999;
                background: rgba(255, 255, 255, 0.85);
                display:none;
            }
            .controls{
                bottom: 0;
                padding: 20px;
                text-align: center;
            }
        </style>

    </head>
    <body>
        <!--[if lt IE 9]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser and many of the features on this page will not appear. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
            <div class="controls">
                <a href="#" class="control" id="cash.on.hand">Cash on hand</a>
                <a href="#" class="control" id="cash.foreign.subsidiary">Cash in foreign subsidiary</a>
                <a href="#" class="control" id="pct.offshore">Percent offshore</a>
                <a href="#" class="control" id="unrepatriated.foreign.income">Unrepatried foreign income</a>
                <a href="#" class="control" id="income.before.taxes">Income before taxes</a>
                <a href="#" class="control" id="est.us.tax.benefit">Estimated U.S. tax benefit</a>
                <a href="#" class="control" id="num.tax.havens">Number of tax havens</a>
            </div>
        <div id="container">
            <div id="info-window"></div>
            <div id="chart" class="charts"></div>
            <!--[if lt IE 9]>
            <div id="chart-1" class="charts"></div>
            <div id="chart-2" class="charts"></div>
            <div id="chart-3" class="charts"></div>
            <div id="chart-4" class="charts"></div>
            <div id="chart-5" class="charts"></div>
            <div id="chart-6" class="charts"></div>
            <![endif]-->
        </div>
        <script type="text/javascript" src="js/vendor/jquery-1.8.3.min.js"></script>
        <script type="text/javascript" src="js/plugins.js"></script>
        <script type="text/javascript" src="js/main.js"></script>
        <script type="text/javascript" src="js/colorbrewer.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>
        <!--[if lte IE 8]><script src="js/es5-shim.min.js"></script><![endif]-->
        <!--[if lt IE 9]><script src="js/raphael-min.js"></script><![endif]-->
        <script type="text/javascript" src="js/d3.v2.min.js"></script>
        <script type="text/javascript" src="js/chartz.js"></script>
        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
        <script>
            var ADD_COMMAS = function(value){
                nStr = value.toString() + '';
                x = nStr.split('.');
                x1 = x[0];
                x2 = x.length > 1 ? '.' + x[1] : '';
                var rgx = /(\d+)(\d{3})/;
                while (rgx.test(x1)) {
                    x1 = x1.replace(rgx, '$1' + ',' + '$2');
                }
                return x1 + x2;
            }; 
            d3.csv("data/sv-top-50.csv", function(data, error) {
                var infoTemplate = _.template($("#info-window-template").html());
                var keyval = [];
                var options = {
                    key: function(entry){return entry.key;},
                    value: function(entry){return entry.value;},
                    comparator: function(a, b){return a.value - b.value;},
                    minRange: 5,
                    maxRange: 40,
                    strokeColor: 'white',
                    fillOpacity: .85,
                    colorKey: function(entry){return entry.color;},
                    left: 100,
                    barPadding: 5 
                };

                data.forEach(function(d){
                    keyval.push({'key': d.company, 'value': parseFloat(d['cash.on.hand'])});
                });

                var formatMap = {
                    'cash.on.hand': function(d) { return "$" + d / 1000000000 + "B"; },
                    'cash.foreign.subsidiary': function(d) { return "$" + d / 1000000000 + "B"; },
                    'pct.offshore': function(d){return d + '%'},
                    'unrepatriated.foreign.income': function(d) { return "$" + d / 1000000000 + "B"; },
                    'income.before.taxes': function(d) { return "$" + d / 1000000000 + "B"; },
                    'effective.tax.rate': function(d){return d;},
                    'est.us.tax.benefit': function(d) { return "$" + d / 1000000000 + "B"; },
                    'num.tax.havens': function(d){return d;}
                };
                var symbolMap = {
                    'cash.on.hand': function(d){return "$" + d;},
                    'cash.foreign.subsidiary': function(d){return "$" + d;},
                    'pct.offshore': function(d){return d + "%";},
                    'unrepatriated.foreign.income': function(d){return "$" + d;},
                    'income.before.taxes': function(d){return "$" + d;},
                    'effective.tax.rate': function(d){return d;},
                    'est.us.tax.benefit': function(d){return "$" + d;},
                    'num.tax.havens': function(d){return d;}
                };

                var curState = "cash.on.hand";

                if(cir.chartz.utils.getIEVersion() === -1 || cir.chartz.utils.getIEVersion() >= 9){
                    var pack = cir.chartz.d3bar("#chart", keyval, options);

                    var getYAxe = function(dim, svg, text, formatFunction){
                        var yscale = d3.scale.linear()
                                .domain([dim.minY, dim.maxY])
                                .range([dim.height, dim.bottom]);
                        var yaxis = cir.chartz.utils.getYAxis(svg, yscale, {
                            'text': text,
                            'dy': '.2em',
                            'transform': 'translate(40,0)',
                            'textTransform': 'translate(-50, 240)rotate(-90)',
                            'tickFormat': formatFunction
                        });
                        return yaxis;
                    };

                    var yaxe = getYAxe(pack.dimensions, pack.svg, 'cash on hand', formatMap['cash.on.hand']);

                    pack.svg.selectAll("rect").style('fill-opacity', .5);
                    var text = d3.selectAll("g .bar")
                        .insert('text', ":first-child").text(function(d){return options.KEY(d);})
                        .attr("transform", function(d, i){
                            var selection = pack.svg.selectAll("rect").filter(function(o, idx){
                                return options.KEY(o) === options.KEY(d);
                            });
                            var x = parseFloat(d3.select(selection).node().attr('x')) + 10;
                            var y = (pack.dimensions.height + pack.dimensions.top) - 3;
                            return "translate("+x+","+y+")rotate(-90)";
                        })
                        .style('opacity', '0')
                        .style('visibility', 'hidden');

                    pack.svg.selectAll("rect").on('mouseover', function(d, i){
                        var format =  d3.format(",f");
                        var variables = {
                            'company': options.KEY(d),
                            'value': symbolMap[curState](format(options.VAL(d)))
                        }
                        $("#info-window").show();
                        $("#info-window").html(infoTemplate(variables));
                        d3.select(this).transition().duration(100)
                        .style("stroke","black")
                        .style("stroke-width","1");
                    });

                    pack.svg.selectAll("rect").on('mouseout', function(d, i){
                        d3.select(this).transition().duration(100)
                        .style("stroke","white")
                        .style("stroke-width","0");
                        text.transition().duration(1).style('visibility', 'hidden');
                        text.transition().duration(100)
                        .style('opacity', '0');
                    });

                    pack.svg.selectAll("rect").on('click', function(d, i){
                        text.filter(function(o, idx){
                            return idx !== i;
                        })
                        .transition().duration(1).style('visibility', 'visible')
                        .transition().duration(100).style('opacity', '1');
                    });

                    $('a').on('click', function(e){
                        var origTarget = e.srcElement || e.target;
                        var thisState =  curState = $(origTarget).attr('id');
                        var keyval = [];

                        data.forEach(function(d){
                            keyval.push({'key': d.company, 'value': parseFloat(d[thisState])});
                        });

                        var dim = cir.chartz.utils.getLinearDimensions($("#chart"), keyval, options);

                        $('.y-axis').remove();
                        console.log(formatMap[thisState])
                        getYAxe(dim, pack.svg, $(origTarget).text(), formatMap[thisState]);

                        pack.svg.selectAll("rect")
                        .transition().duration(1000)
                        .attr("height", function(d){
                            var obj = _.find(keyval, function(y){
                                return options.KEY(d) === options.KEY(y);
                            });
                            d.value = options.VAL(obj);
                            if(options.VAL(obj) <= 0.0)
                                return 0;
                            return dim.yscale(options.VAL(obj));
                        })
                        .attr("y", function(d){
                            var obj = _.find(keyval, function(y){
                                return options.KEY(d) === options.KEY(y);
                            });
                            return dim.top + (dim.height - dim.yscale(options.VAL(obj)));
                        })
                        return false;
                    });
                }else{
                    var bars = [cir.chartz.bar("#chart", keyval, options)];
                    var idx = 0;
                    _.each(_.keys(formatMap), function(key){
                        if(idx !== 0){
                            var id = "#chart-" + idx;
                            var keyval = [];
                            data.forEach(function(d){
                                keyval.push({'key': d.company, 'value': parseFloat(d[key])});
                            });
                            var bar = cir.chartz.bar(id, keyval, options)
                        }
                        idx++;
                    });
                    
                }
            });
        </script>
        <script type="text/template" id="info-window-template">
            <ul>
                <li><%= company %></li>
                <li><%= value %></li>
            </ul>
        </script>
    </body>
</html>
